/**
 * @license
 * ReduxedChromeStorage v3.0.10
 * https://github.com/hindmost/reduxed-chrome-storage
 * Copyright (c) Savr Goryaev aka hindmost
 *
 * This source code is licensed under the MIT license
 * https://github.com/hindmost/reduxed-chrome-storage/blob/master/LICENSE
 *
 * Dependencies:
 *
 * tslib v2.5.0
 *
 * uuid v8.3.2
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).reduxedChromeStorage={})}(this,(function(t){"use strict";function e(t,e,r,i){return new(r||(r=Promise))((function(n,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))}var r,i=new Uint8Array(16);function n(){if(!r&&!(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(i)}var o=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;for(var s=[],a=0;256>a;++a)s.push((a+256).toString(16).substr(1));function u(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=(s[t[e+0]]+s[t[e+1]]+s[t[e+2]]+s[t[e+3]]+"-"+s[t[e+4]]+s[t[e+5]]+"-"+s[t[e+6]]+s[t[e+7]]+"-"+s[t[e+8]]+s[t[e+9]]+"-"+s[t[e+10]]+s[t[e+11]]+s[t[e+12]]+s[t[e+13]]+s[t[e+14]]+s[t[e+15]]).toLowerCase();if(!function(t){return"string"==typeof t&&o.test(t)}(r))throw TypeError("Stringified UUID is invalid");return r}function c(t,e,r){var i=(t=t||{}).random||(t.rng||n)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,e){r=r||0;for(var o=0;16>o;++o)e[r+o]=i[o];return e}return u(i)}function h(t){return null==t||"object"!=typeof t?t:JSON.parse(JSON.stringify(t))}function f(t,e){if(t===e)return!0;if(null==t||"object"!=typeof t||null==e||"object"!=typeof e||Array.isArray(t)!==Array.isArray(e))return!1;var r=Object.keys(t),i=Object.keys(e);if(r.length!==i.length)return!1;for(var n=0,o=r;o.length>n;n+=1){var s=o[n];if(-1>=i.indexOf(s)||!f(t[s],e[s]))return!1}return!0}var p,l=function(t){if(void 0===t||!Array.isArray(t)||3!==t.length)return[t,"",0];var e=t[0],r=t[1];return"string"==typeof e&&"number"==typeof r?[t[2],e,r]:[t,"",0]},d=function(t,e,r,i,n,o,s){this.container=t,this.storage=e,this.isolated=r,this.plain=i,this.timeout=n?Math.max(n,500):1e3,this.resetState=s,this.state=null,this.id=c(),this.tmstamp=0,this.outdted=[],"function"==typeof o&&(this.lisner=o),this.lisners=[],this.getState=this.getState.bind(this),this.subscribe=this.subscribe.bind(this),this.dispatch=this.dispatch.bind(this),this.replaceReducer=this.replaceReducer.bind(this),this[Symbol.observable]=this[Symbol.observable].bind(this)};d.prototype.init=function(){return e(this,void 0,void 0,(function*(){var t=this;this.store=yield this._instantiateStore(),this.tmstamp||this.isolated||this.storage.subscribe((function(r){return e(t,void 0,void 0,(function*(){var t=l(r),e=t[0],i=t[2];t[1]===this.id||f(e,this.state)||i>=this.tmstamp&&(this._setState(e,i),yield this._renewStore(),f(e,this.state)||this._send2Storage(),this._callListeners())}))}));var r=this.store.getState();return new Promise((function(i){t.storage.load((function(n){return e(t,void 0,void 0,(function*(){var t=l(n),e=t[0],o=t[2],s=e||r;this.resetState&&Object.keys(this.resetState).length>0&&(s=this.resetState),this._setState(s,o),yield this._renewStore(),f(s,e)||this._send2Storage(),i(this)}))}))}))}))},d.prototype.initFrom=function(t){return e(this,void 0,void 0,(function*(){return this._setState(t,0),yield this._renewStore(),this}))},d.prototype._setState=function(t,e){this.state=h(t),(e=void 0!==e?e:Date.now())>this.tmstamp&&(this.tmstamp=e)},d.prototype._renewStore=function(){return e(this,void 0,void 0,(function*(){var t=this;this.plain?this.unsub&&this.unsub():this._clean();var r=this.store=yield this._instantiateStore(this.state),i=Date.now(),n=this.outdted.length;this.outdted=this.outdted.map((function(t,e){var r=t[0],o=t[1];return r||e>=n-1?[r,o]:[i,o]}));var o=h(this.state),s=this.store.subscribe((function(){return e(t,void 0,void 0,(function*(){var t=r&&r.getState(),e=this.store===r;this._clean(),f(t,this.state)||(e?this._setState(t):(this._setState(t),yield this._renewStore()),this._send2Storage(),this._callListeners(!0,o),o=h(t))}))}));this.plain?this.unsub=s:this.outdted.push([0,s])}))},d.prototype._clean=function(){var t=this;if(!this.plain){var e=Date.now(),r=this.outdted.length;this.outdted.forEach((function(i,n){r-1>n&&e-i[0]>=t.timeout&&((0,i[1])(),delete t.outdted[n])}))}},d.prototype._instantiateStore=function(t){return e(this,void 0,void 0,(function*(){var e=yield this.container(t);if("object"!=typeof e||"function"!=typeof e.getState)throw Error("Invalid 'storeCreatorContainer' supplied");return e}))},d.prototype._send2Storage=function(){this.storage.save([this.id,this.tmstamp,this.state])},d.prototype._callListeners=function(t,e){t&&this.lisner&&this.lisner(this,e);for(var r=0,i=this.lisners;i.length>r;r+=1){(0,i[r])()}},d.prototype.getState=function(){return this.state},d.prototype.subscribe=function(t){var e=this;return"function"==typeof t&&this.lisners.push(t),function(){"function"==typeof t&&(e.lisners=e.lisners.filter((function(e){return e!==t})))}},d.prototype.dispatch=function(t){return this.store&&this.store.dispatch(t)},d.prototype.replaceReducer=function(t){return"function"==typeof t&&this.store&&this.store.replaceReducer(t),this},d.prototype[Symbol.observable]=function(){var t,e=this.getState,r=this.subscribe;return(t={subscribe:function(t){if("object"!=typeof t||null===t)throw new TypeError("Expected the observer to be an object.");function i(){t.next&&t.next(e())}return i(),{unsubscribe:r(i)}}})[Symbol.observable]=function(){return this},t},function(t){t.local="local",t.sync="sync"}(p||(p={}));var y=function(t){return(new TextEncoder).encode(Object.entries(t).map((function(t){return t[0]+JSON.stringify(t[1])})).join("")).length},b=function(t){var e=t.area,r=t.key;this.ns=t.namespace,this.areaName=e===p.sync?p.sync:p.local,this.key=r||"reduxed",this.listeners=[],this.errListeners=[]};b.prototype.regShared=function(){var t=this;this.regListener((function(e,r){for(var i=0,n=t.listeners;n.length>i;i+=1){(0,n[i])(e,r)}}))},b.prototype.regListener=function(t){var e=this;this.ns.storage.onChanged.addListener((function(r,i){if(i===e.areaName&&e.key in r){var n=r[e.key],o=n.newValue;o&&t(o,n.oldValue)}}))},b.prototype.subscribe=function(t){"function"==typeof t&&this.listeners.push(t)},b.prototype.subscribeForError=function(t){"function"==typeof t&&this.errListeners.push(t)},b.prototype.fireErrorListeners=function(t,e){for(var r=0,i=this.errListeners;i.length>r;r+=1){(0,i[r])(t,e)}},b.prototype.callbackOnLoad=function(t,e,r){e(!this.ns.runtime.lastError&&(r?t:t&&t[this.key]))},b.prototype.callbackOnSave=function(t,e){var r,i=this;if(this.ns.runtime.lastError){var n=this.ns.runtime.lastError.message;if(n&&t&&e)this.areaName===p.sync&&e.QUOTA_BYTES_PER_ITEM&&y(((r={})[this.key]=t,r))>e.QUOTA_BYTES_PER_ITEM?this.fireErrorListeners(n,!0):this.load((function(r){var o,s="object"==typeof r&&e.QUOTA_BYTES>0&&y(Object.assign(Object.assign({},r),((o={})[i.key]=t,o)))>e.QUOTA_BYTES;i.fireErrorListeners(n,s)}),!0);else this.fireErrorListeners(n||"",!1)}};var v,g=function(t){function e(e){t.call(this,{namespace:e.namespace,area:e.area,key:e.key}),this.areaApi=this.ns.storage[this.areaName]}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.load=function(t,e){var r=this;"function"==typeof t&&this.areaApi.get(e?null:this.key,(function(i){r.callbackOnLoad(i,t,e)}))},e.prototype.save=function(t){var e,r=this;this.areaApi.set(((e={})[this.key]=t,e),(function(){r.callbackOnSave(t,r.areaApi)}))},e}(b),m=function(t){function e(e){t.call(this,{namespace:e.namespace,area:e.area,key:e.key}),this.areaApi=this.ns.storage[this.areaName]}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.load=function(t,e){var r=this;"function"==typeof t&&this.areaApi.get(e?null:this.key).then((function(e){r.callbackOnLoad(e,t)}))},e.prototype.save=function(t){var e,r=this;this.areaApi.set((e={},e[this.key]=t,e)).then((function(){r.callbackOnSave(t,r.areaApi)}))},e}(b);!function(t){t.chrome="chrome",t.browser="browser"}(v||(v={})),t.cloneDeep=h,t.diffDeep=function t(e,r){if(e!==r){if(null==e||"object"!=typeof e||null==r||"object"!=typeof r)return e;if(Array.isArray(e)||Array.isArray(r))return f(e,r)?void 0:e;var i=Object.keys(e),n=Object.keys(r),o=!0,s=i.reduce((function(i,s){var a=n.indexOf(s)>-1?t(e[s],r[s]):e[s];return void 0===a||(o=!1,i[s]=a),i}),{});return n.forEach((function(t){i.indexOf(t)>-1||(o=!1,s[t]=void 0)})),o?void 0:s}},t.isEqual=f,t.mergeOrReplace=function t(e,r,i){if(Array.isArray(r))return h(r);if(null==e||"object"!=typeof e||Array.isArray(e)||null==r||"object"!=typeof r)return h(void 0!==r?r:e);var n=Object.keys(e).concat(Object.keys(r).filter((function(t){return!(t in e)}))).reduce((function(n,o){return n[o]=t(e[o],r[o],i),n}),{});if(!i)return n;var o=Object.keys(r);return Object.keys(e).forEach((function(t){o.indexOf(t)>-1||delete n[t]})),n},t.setupReduxed=function(t,r,i){var n=this,o=r||{},s=o.namespace,a=o.chromeNs,u=o.browserNs,c=o.storageArea,h=o.storageKey,f=o.isolated,p=o.plainActions,y=o.outdatedTimeout,b=i||{},S=b.onGlobalChange,_=b.onLocalChange,O=b.onError;if("function"!=typeof t)throw Error("Missing argument for 'storeCreatorContainer'");var k=u||s===v.browser?new m({namespace:u||browser,area:c,key:h}):new g({namespace:a||chrome,area:c,key:h});return"function"==typeof S&&k.regListener((function(r,i){return e(n,void 0,void 0,(function*(){var e=new d(t,k,!0,p),n=l(r)[0],o=l(i)[0];S(yield e.initFrom(n),o)}))})),f||k.regShared(),function(e){return O&&k.subscribeForError(O),new d(t,k,f,p,y,_,e).init()}},Object.defineProperty(t,"__esModule",{value:!0})}));
